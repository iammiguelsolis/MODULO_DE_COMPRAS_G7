{% extends "base.html" %}
{% block titulo2 %} Gestión Administrador {% endblock %}
{% block title %}Crear Nuevo Usuario{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Crear Cuenta de Usuario</h2>
    <a href="{{ url_for('administrador_bp.panel_principal') }}" class="btn btn-secondary">Volver</a>
</div>

<form id="form-usuario">
    <div class="mb-3">
        <label>DNI:</label>
        <input type="text" class="form-control" name="dni" required pattern="\d{8}" maxlength="8" title="Debe tener exactamente 8 dígitos numéricos">
    </div>
    <div class="mb-3">
        <label>Contraseña:</label>
        <input type="password" class="form-control" name="contraseña" required>
    </div>
    <div class="mb-3">
        <label>Nombre:</label>
        <input type="text" class="form-control" name="nombre" required pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+" title="Solo se permiten letras y espacios">
    </div>
    <div class="mb-3">
        <label>Apellido:</label>
        <input type="text" class="form-control" name="apellido" required pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+" title="Solo se permiten letras y espacios">
    </div>
    <div class="mb-3">
        <label>Teléfono:</label>
        <input type="text" class="form-control" name="telefono" required pattern="9\d{8}" maxlength="9" title="Debe comenzar con 9 y tener exactamente 9 dígitos">
    </div>
    <div class="mb-3">
        <label>Fecha de Nacimiento:</label>
        <input type="date" class="form-control" name="fecha_nacimiento" required id="fecha_nacimiento">
    </div>
    <div class="mb-3">
        <label>Sexo:</label>
        <select class="form-select" name="sexo" required>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
        </select>
    </div>
    <div class="mb-3">
        <label>Tipo de Usuario:</label>
        <select class="form-select" name="tipo_usuario" id="tipo_usuario" required>
            <option value="Colaborador">Colaborador</option>
            <option value="Terapeuta">Terapeuta</option>
            <option value="Administrador">Administrador</option>
        </select>
    </div>
    <div class="mb-3 d-none" id="bloque_nivel">
        <label>Nivel de Autoridad:</label>
        <select class="form-select" name="nivel_autoridad">
            <option value="1">1 - Bajo</option>
            <option value="2">2 - Alto</option>
        </select>
    </div>
    <div class="mb-3 d-none" id="bloque_especialidad">
        <label>Especialidades (selecciona una o más):</label>
        <div id="lista_especialidades"></div>
    </div>
    <button type="submit" class="btn btn-primary">Crear Usuario</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const hoy = new Date();
    hoy.setMinutes(hoy.getMinutes() - hoy.getTimezoneOffset());
    const fechaHoy = hoy.toISOString().split("T")[0];
    document.getElementById("fecha_nacimiento").setAttribute("max", fechaHoy);

    fetch('/admin/especialidades')
        .then(res => res.json())
        .then(data => {
            const contenedor = document.getElementById('lista_especialidades');
            data.forEach(esp => {
                contenedor.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="especialidades" value="${esp.id}">
                        <label class="form-check-label">${esp.nombre}</label>
                    </div>
                `;
            });
        });

    document.getElementById('tipo_usuario').addEventListener('change', function () {
        const tipo = this.value;
        document.getElementById('bloque_nivel').classList.toggle('d-none', tipo !== 'Administrador');
        document.getElementById('bloque_especialidad').classList.toggle('d-none', tipo !== 'Terapeuta');
    });

    document.getElementById('form-usuario').addEventListener('submit', function (e) {
        e.preventDefault();
        const form = new FormData(this);
        const tipo = form.get('tipo_usuario');

        const data = {
            dni: form.get('dni'),
            contraseña: form.get('contraseña'),
            nombre: form.get('nombre'),
            apellido: form.get('apellido'),
            telefono: form.get('telefono'),
            fecha_nacimiento: form.get('fecha_nacimiento'),
            sexo: form.get('sexo'),
            tipo_usuario: tipo
        };

        if (tipo === 'Administrador') {
            data.nivel_autoridad = form.get('nivel_autoridad');
        }

        if (tipo === 'Terapeuta') {
            const checks = document.querySelectorAll('input[name="especialidades"]:checked');
            data.especialidades = Array.from(checks).map(e => parseInt(e.value));
        }

        fetch('/admin/crear_usuario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(json => {
            alert(json.mensaje || json.error);
            if (json.mensaje) {
                document.getElementById('form-usuario').reset();
                document.getElementById('bloque_nivel').classList.add('d-none');
                document.getElementById('bloque_especialidad').classList.add('d-none');
            }
        })
        .catch(err => {
            alert('Error al enviar datos');
            console.error(err);
        });
    });
});
</script>
{% endblock %}
