{% extends "base.html" %}
{% block title %}Eliminar Usuario{% endblock %}

{% block content %}
<h2 class="mb-4">Eliminar Usuario</h2>

<div class="mb-3">
  <label for="filtro_tipo" class="form-label">Filtrar por tipo de usuario:</label>
  <select id="filtro_tipo" class="form-select">
    <option value="">Todos</option>
    <option value="Admin">Administrador</option>
    <option value="Terapeuta">Terapeuta</option>
    <option value="Colaborador">Colaborador</option>
  </select>
</div>

<div class="mb-3">
  <label for="buscar" class="form-label">Buscar por nombre, apellido o DNI:</label>
  <input type="text" id="buscar" class="form-control" placeholder="Ej: Juan, Pérez, 12345678">
</div>

<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Apellido</th>
      <th>Tipo</th>
      <th>Bloqueado</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tabla_usuarios"></tbody>
</table>

<div class="mt-4">
  <a href="{{ url_for('administrador_bp.panel_principal') }}" class="btn btn-secondary">Volver al Panel Principal</a>
</div>

<script>

function cargarUsuarios() {
  const tipo = document.getElementById("filtro_tipo").value;
  const buscar = document.getElementById("buscar").value.trim();

  let url = '/admin/usuarios';
  const params = new URLSearchParams();

  if (tipo) params.append('tipo', tipo);
  if (buscar) params.append('buscar', buscar);

  if ([...params].length > 0) {
    url += '?' + params.toString();
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const tabla = document.getElementById("tabla_usuarios");
      tabla.innerHTML = '';
      if (data.length === 0) {
        tabla.innerHTML = '<tr><td colspan="6">No se encontraron usuarios.</td></tr>';
        return;
      }

      data.forEach(u => {
        let acciones = '';

        if (u.tipo === "Terapeuta" && u.bloqueado) {
          acciones = `
            <button class="btn btn-warning btn-sm" onclick="desbloquearUsuario(${u.id})">
             Desbloquear
            </button>`;
        } else {
          acciones = `
            <button class="btn btn-danger btn-sm" onclick="eliminarUsuario(${u.id}, '${u.tipo}')">
              Eliminar
            </button>`;
        }

        tabla.innerHTML += `
          <tr>
            <td>${u.id}</td>
            <td>${u.nombre}</td>
            <td>${u.apellido}</td>
            <td>${u.tipo}</td>
            <td>${u.bloqueado ? 'Sí' : 'No'}</td>
            <td>${acciones}</td>
          </tr>`;
      });
    });
}



function eliminarUsuario(id, tipo) {
  let mensaje = "¿Estás seguro de eliminar este usuario?";
  
  if (tipo === "Terapeuta") {
    mensaje = "Eliminar al terapeuta solo lo bloqueará. Si ya está bloqueado, no se podrá eliminar. ¿Continuar?";
  } else if (tipo === "Administrador") {
    mensaje = "Eliminará virtualmente al administrador si tiene menor autoridad. ¿Continuar?";
  }

  if (!confirm(mensaje)) return;

  fetch(`/admin/eliminar_usuario/${id}`, {
    method: 'DELETE'
  })
    .then(res => res.json())
    .then(resp => {
      alert(resp.mensaje || resp.error);
      cargarUsuarios(document.getElementById("filtro_tipo").value);
    });
}


// Inicial
cargarUsuarios();

document.getElementById("filtro_tipo").addEventListener("change", function () {
  cargarUsuarios(this.value);
});

document.getElementById("buscar").addEventListener("input", function () {
  cargarUsuarios();
});

function desbloquearUsuario(id) {
  if (!confirm("¿Deseas desbloquear a este terapeuta?")) return;
  fetch(`/admin/desbloquear_usuario/${id}`, {
    method: 'PATCH'
  })
    .then(res => res.json())
    .then(resp => {
      alert(resp.mensaje || resp.error);
      cargarUsuarios();
    });
}


</script>

{% endblock %}

